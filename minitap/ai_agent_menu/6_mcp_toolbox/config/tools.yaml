# MCP Toolbox for Databases - Google Trends カスタムツール設定
# 公式ドキュメント準拠形式

# データソース定義
sources:
  google-trends-bigquery:
    kind: bigquery
    project: data-agent-bq
    location: us

# ツール定義
tools:
  # MCP Toolbox for BQ Prebuilt tools
  # ask_data_insights:
  #   kind: bigquery-conversational-analytics
  #   source: google-trends-bigquery
  #   description: |
  #     Use this tool to perform data analysis, get insights, or answer complex 
  #     questions about the contents of specific BigQuery tables.

  execute_sql_tool:
    kind: bigquery-execute-sql
    source: google-trends-bigquery
    description: "Execute SQL query on Google Trends BigQuery dataset"

  bigquery_get_dataset_info:
    kind: bigquery-get-dataset-info
    source: google-trends-bigquery
    description: Use this tool to get dataset metadata.

  bigquery_get_table_info:
    kind: bigquery-get-table-info
    source: google-trends-bigquery
    description: Use this tool to get table metadata.
  
   # 日本のトレンド取得ツール（カスタム）
  get_japan_trends:
    kind: bigquery-sql
    source: google-trends-bigquery
    description: "Get top trending terms for Japan from Google Trends dataset"
    parameters:
      - name: days
        type: integer
        description: "Number of days to look back from current date"
        default: 7
      - name: limit
        type: integer
        description: "Maximum number of results to return"
        default: 10
    statement: |
      WITH RankedTerms AS (
        SELECT 
          term,
          country_name,
          region_name,
          week,
          rank,
          score,
          -- term ごとに、ランクが一番高く(ASC)、週が最新(DESC)の行に 1 を振る
          ROW_NUMBER() OVER(
            PARTITION BY term 
            ORDER BY rank ASC, week DESC
          ) as rn
        FROM `bigquery-public-data.google_trends.international_top_terms`
        WHERE country_code = 'JP'
          AND week >= DATE_SUB(CURRENT_DATE(), INTERVAL @days DAY)
      )
      -- 1 番の行（＝各termのベストランク）のみを抽出
      SELECT
        term,
        country_name,
        region_name,
        week,
        rank,
        score
      FROM RankedTerms
      WHERE rn = 1
      ORDER BY rank ASC, week DESC -- 最終結果をランク順で並び替え
      LIMIT @limit

# ツールセット定義
toolsets:
  google-trends-analysis:
    - execute_sql_tool
    - bigquery_get_dataset_info
    - bigquery_get_table_info
    - get_japan_trends
